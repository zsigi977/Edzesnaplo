<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Edz√©sNapl√≥ Pro</title>
    
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Edz√©sNapl√≥">

    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: url('hatter.png') no-repeat center center fixed; 
            background-size: cover; 
            margin: 0; padding: 20px; 
            display: flex; flex-direction: column; align-items: center; 
            min-height: 100vh; 
        }

        #app { 
            background: rgba(255, 255, 255, 0.75); 
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            padding: 20px; border-radius: 25px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.2); 
            width: 95%; max-width: 500px; 
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-sizing: border-box;
        }

        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 12px; border-radius: 12px; border: none; background: rgba(255,255,255,0.4); cursor: pointer; font-weight: bold; font-size: 14px; }
        .tab-btn.active { background: #007aff; color: white; }

        .card { 
            background: rgba(255, 255, 255, 0.6); 
            padding: 15px; border-radius: 15px; 
            margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.4); 
            position: relative; 
        }
        
        h3 { margin: 0 0 10px 0; color: #1c1c1e; font-size: 18px; }
        input, select { padding: 10px; border-radius: 8px; border: 1px solid rgba(0,0,0,0.1); font-size: 14px; margin-bottom: 10px; width: 100%; box-sizing: border-box; background: rgba(255,255,255,0.8); }
        
        .exercise-block { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .exercise-name { font-weight: bold; font-size: 15px; color: #007aff; display: block; margin-bottom: 5px; }
        .exercise-row { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 8px; }
        .set-input { padding: 8px; text-align: center; font-size: 13px; margin-bottom: 0; }

        .btn-primary { background: #007aff; color: white; border: none; padding: 14px; border-radius: 12px; width: 100%; font-weight: bold; cursor: pointer; font-size: 16px; }
        .btn-delete { background: none; border: none; color: #ff3b30; cursor: pointer; font-size: 18px; padding: 5px; }
        .btn-search { background: rgba(0,0,0,0.1); color: #333; border: none; padding: 10px; border-radius: 8px; margin-bottom: 15px; width: 100%; font-weight: bold; }

        .history-card { border-left: 5px solid #007aff; }
        .history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .weight-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(0,0,0,0.05); }
        
        .avg-week { padding: 8px; background: rgba(52, 199, 89, 0.15); border-radius: 8px; margin: 8px 0; font-weight: bold; color: #248a3d; font-size: 13px; text-align: center; border: 1px dashed #34c759; }
        .avg-month { padding: 10px; background: rgba(0, 122, 255, 0.15); border-radius: 8px; margin: 10px 0; font-weight: bold; color: #007aff; font-size: 14px; text-align: center; border: 1px solid #007aff; }

        .hidden { display: none; }
        .search-box { background: rgba(255,255,255,0.3); padding: 10px; border-radius: 10px; margin-bottom: 15px; }
        .day-label { font-size: 12px; color: #666; font-weight: normal; }
    </style>
</head>
<body>

<div id="app">
    <div class="tabs">
        <button id="btn-tab-workout" class="tab-btn active" onclick="showTab('workout')">üèãÔ∏è Edz√©s</button>
        <button id="btn-tab-weight" class="tab-btn" onclick="showTab('weight')">‚öñÔ∏è S√∫ly</button>
    </div>

    <div id="tab-workout">
        <div class="card">
            <h3>√öj Edz√©s R√∂gz√≠t√©se</h3>
            <input type="date" id="workoutDate">
            <select id="workoutType" onchange="loadTemplate()">
                <option value="">-- V√°lassz t√≠pust --</option>
                <option value="felso">Fels≈ëtest</option>
                <option value="also">Als√≥test</option>
            </select>
            <div id="exercise-container"></div>
            <button class="btn-primary" onclick="saveWorkout()">Edz√©s Ment√©se</button>
        </div>
        
        <div class="search-box">
            <input type="date" id="searchDate" onchange="filterWorkouts()">
            <button class="btn-search" onclick="clearSearch()">Minden el≈ëzm√©ny</button>
        </div>

        <div id="history-container"></div>
    </div>

    <div id="tab-weight" class="hidden">
        <div class="card">
            <h3>Tests√∫ly Napl√≥</h3>
            <div style="display: flex; gap: 10px;">
                <input type="date" id="weightDate" style="flex: 2;">
                <input type="number" id="weightInput" step="0.1" placeholder="kg" style="flex: 1;">
                <button class="btn-primary" style="padding: 10px; width: auto;" onclick="saveWeight()">OK</button>
            </div>
        </div>
        <div class="card">
            <h3>Napl√≥ & Statisztika</h3>
            <div id="weightEntries"></div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, push, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCslE4Kc229j41Sm2l7ovpc_KEWhOb107k",
        authDomain: "bevasarlolista-dd660.firebaseapp.com",
        databaseURL: "https://bevasarlolista-dd660-default-rtdb.firebaseio.com",
        projectId: "bevasarlolista-dd660",
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const templates = {
        felso: ["Mellt√°maszos evez√©s", "Mellhez h√∫z√°s", "Fekvenyom√≥ g√©p", "V√°llb√≥l nyom√≥ g√©p", "Oldalemel√©s", "Bicepsz", "Tricepsz"],
        also: ["L√°btol√≥", "Combfesz√≠t≈ë", "Combhajl√≠t√≥", "Combk√∂zel√≠t≈ë", "Hip Thrust", "V√°dli"]
    };

    const napok = ["Vas√°rnap", "H√©tf≈ë", "Kedd", "Szerda", "Cs√ºt√∂rt√∂k", "P√©ntek", "Szombat"];

    function getWeekId(dateStr) {
        const d = new Date(dateStr);
        d.setHours(0, 0, 0, 0);
        d.setDate(d.getDate() + 4 - (d.getDay() || 7));
        const yearStart = new Date(d.getFullYear(), 0, 1);
        return d.getFullYear() + "-W" + Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    }

    // --- EDZ√âS FUNKCI√ìK ---
    window.saveWorkout = () => {
        const date = document.getElementById('workoutDate').value;
        const type = document.getElementById('workoutType').value;
        if (!date || !type) return alert("D√°tum √©s t√≠pus k√∂telez≈ë!");

        const workoutData = { date, type, exercises: [] };
        templates[type].forEach((ex, idx) => {
            let sets = [
                document.getElementById(`ex-${idx}-1`).value,
                document.getElementById(`ex-${idx}-2`).value,
                document.getElementById(`ex-${idx}-3`).value,
                document.getElementById(`ex-${idx}-4`).value
            ];
            
            // Intelligens form√°z√°s: 50x12 -> 50 kg x 12
            const formattedSets = sets.map(s => {
                if(s.includes('x') && !s.toLowerCase().includes('kg')) {
                    let parts = s.split('x');
                    return `${parts[0].trim()} kg x ${parts[1].trim()}`;
                }
                return s;
            });

            workoutData.exercises.push({ name: ex, sets: formattedSets });
        });

        push(ref(db, 'workouts'), workoutData).then(() => {
            alert("Edz√©s mentve!");
            document.getElementById('exercise-container').innerHTML = "";
            document.getElementById('workoutType').value = "";
        });
    };

    function renderWorkouts(list) {
        const container = document.getElementById('history-container');
        container.innerHTML = "<h3>El≈ëzm√©nyek</h3>";
        list.forEach(workout => {
            const d = new Date(workout.date);
            const card = document.createElement('div');
            card.className = "card history-card";
            let exHtml = "";
            workout.exercises.forEach(ex => {
                const filled = ex.sets.filter(s => s && s.trim() !== "");
                if (filled.length > 0) exHtml += `<div style="font-size:13px; margin-top:5px;"><strong>${ex.name}:</strong> ${filled.join(' | ')}</div>`;
            });
            card.innerHTML = `<div class="history-header"><strong>${workout.date} <span class="day-label">(${napok[d.getDay()]})</span></strong><button class="btn-delete" onclick="deleteWorkout('${workout.id}')">üóëÔ∏è</button></div>${exHtml}`;
            container.appendChild(card);
        });
    }

    // --- S√öLY FUNKCI√ìK ---
    onValue(ref(db, 'weight_logs'), (snapshot) => {
        const data = snapshot.val();
        const container = document.getElementById('weightEntries');
        container.innerHTML = "";
        if (!data) return;

        const sortedDates = Object.keys(data).sort().reverse();
        let weekSum = 0, weekCount = 0, monthSum = 0, monthCount = 0;
        let lastWeekId = null, lastMonthId = null;

        sortedDates.forEach((date, index) => {
            const val = data[date].weight;
            const d = new Date(date);
            const weekId = getWeekId(date);
            const monthId = date.substring(0, 7);

            if (lastMonthId && lastMonthId !== monthId) {
                container.innerHTML += `<div class="avg-month">üìÖ Havi √°tlag (${lastMonthId}): ${(monthSum/monthCount).toFixed(2)} kg</div>`;
                monthSum = 0; monthCount = 0;
            }
            if (lastWeekId && lastWeekId !== weekId) {
                container.innerHTML += `<div class="avg-week">‚öñÔ∏è Heti √°tlag: ${(weekSum/weekCount).toFixed(2)} kg</div>`;
                weekSum = 0; weekCount = 0;
            }

            lastWeekId = weekId; lastMonthId = monthId;

            container.innerHTML += `
                <div class="weight-row">
                    <span>${date} <small>(${napok[d.getDay()]})</small>: <strong>${val} kg</strong></span>
                    <button class="btn-delete" style="font-size:14px;" onclick="deleteWeight('${date}')">üóëÔ∏è</button>
                </div>`;
            
            weekSum += val; weekCount++;
            monthSum += val; monthCount++;

            if (index === sortedDates.length - 1) {
                container.innerHTML += `<div class="avg-week">‚öñÔ∏è Heti √°tlag: ${(weekSum/weekCount).toFixed(2)} kg</div>`;
                container.innerHTML += `<div class="avg-month">üìÖ Havi √°tlag (${monthId}): ${(monthSum/monthCount).toFixed(2)} kg</div>`;
            }
        });
    });

    // --- ALAP FUNKCI√ìK (V√°ltozatlanok) ---
    window.loadTemplate = () => {
        const type = document.getElementById('workoutType').value;
        const container = document.getElementById('exercise-container');
        container.innerHTML = "";
        if (!type) return;
        templates[type].forEach((ex, idx) => {
            const div = document.createElement('div');
            div.className = "exercise-block";
            div.innerHTML = `<span class="exercise-name">${ex}</span><div class="exercise-row">
                <input type="text" class="set-input" placeholder="1." id="ex-${idx}-1">
                <input type="text" class="set-input" placeholder="2." id="ex-${idx}-2">
                <input type="text" class="set-input" placeholder="3." id="ex-${idx}-3">
                <input type="text" class="set-input" placeholder="4." id="ex-${idx}-4">
            </div>`;
            container.appendChild(div);
        });
    };

    window.saveWeight = () => {
        const date = document.getElementById('weightDate').value;
        const weight = document.getElementById('weightInput').value;
        if (date && weight) set(ref(db, 'weight_logs/' + date), { weight: parseFloat(weight) }).then(() => document.getElementById('weightInput').value = "");
    };

    window.deleteWorkout = (id) => { if(confirm("T√∂rl√∂d?")) remove(ref(db, `workouts/${id}`)); };
    window.deleteWeight = (date) => { if(confirm("T√∂rl√∂d?")) remove(ref(db, `weight_logs/${date}`)); };
    window.showTab = (tab) => {
        document.getElementById('tab-workout').classList.toggle('hidden', tab !== 'workout');
        document.getElementById('tab-weight').classList.toggle('hidden', tab !== 'weight');
        document.getElementById('btn-tab-workout').classList.toggle('active', tab === 'workout');
        document.getElementById('btn-tab-weight').classList.toggle('active', tab === 'weight');
    };
    window.filterWorkouts = () => renderWorkouts(allWorkouts.filter(w => w.date === document.getElementById('searchDate').value));
    window.clearSearch = () => { document.getElementById('searchDate').value = ""; renderWorkouts(allWorkouts); };

    let allWorkouts = [];
    onValue(ref(db, 'workouts'), (snapshot) => {
        const data = snapshot.val();
        allWorkouts = data ? Object.keys(data).map(key => ({ id: key, ...data[key] })).sort((a,b) => new Date(b.date) - new Date(a.date)) : [];
        if (!document.getElementById('searchDate').value) renderWorkouts(allWorkouts);
    });

    document.getElementById('workoutDate').valueAsDate = new Date();
    document.getElementById('weightDate').valueAsDate = new Date();
</script>
</body>
</html>