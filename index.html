<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Edz√©sNapl√≥ Pro</title>
    
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Edz√©sNapl√≥">

    <style>
        * { box-sizing: border-box; }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: url('hatter.png') no-repeat center center fixed; 
            background-size: cover; 
            margin: 0; padding: 10px; 
            display: flex; flex-direction: column; align-items: center; 
            min-height: 100vh; 
        }

        #app { 
            background: rgba(255, 255, 255, 0.75); 
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            padding: 15px; border-radius: 25px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.2); 
            width: 100%; max-width: 500px; 
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .tabs { display: flex; gap: 8px; margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 12px; border-radius: 12px; border: none; background: rgba(255,255,255,0.4); cursor: pointer; font-weight: bold; font-size: 14px; }
        .tab-btn.active { background: #007aff; color: white; }

        .card { 
            background: rgba(255, 255, 255, 0.6); 
            padding: 15px; border-radius: 15px; 
            margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.4); 
            width: 100%; /* Fix: A k√°rtya mindig t√∂ltse ki az appot */
        }
        
        /* FIX√ÅLT INPUT ST√çLUS - NEM FOG KIL√ìGNI */
        input, select { 
            padding: 12px; 
            border-radius: 8px; 
            border: 1px solid rgba(0,0,0,0.1); 
            font-size: 16px; 
            margin-bottom: 10px; 
            width: 100% !important; 
            display: block;
            background: rgba(255,255,255,0.8);
            -webkit-appearance: none; /* iOS fix */
            appearance: none;
        }

        /* Speci√°lis fix a d√°tumv√°laszt√≥nak mobilra */
        input[type="date"] {
            min-height: 44px;
            max-width: 100%;
        }

        .weight-input-group { display: flex; flex-direction: column; gap: 5px; }

        @media (min-width: 400px) {
            .weight-input-group { flex-direction: row; align-items: center; }
            .weight-input-group input[type="date"] { flex: 2; margin-bottom: 0; }
            .weight-input-group input[type="number"] { flex: 1; margin-bottom: 0; }
            .weight-input-group .btn-ok { width: auto; height: 44px; margin-top: 0; flex: 0.5; }
        }

        .exercise-block { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid rgba(0,0,0,0.05); position: relative; }
        .exercise-name { font-weight: bold; font-size: 15px; color: #007aff; display: block; margin-bottom: 8px; width: 85%; outline: none; }
        .exercise-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; }
        .set-input { padding: 8px; text-align: center; font-size: 12px; margin-bottom: 0; }

        .btn-primary { background: #007aff; color: white; border: none; padding: 14px; border-radius: 12px; width: 100%; font-weight: bold; cursor: pointer; font-size: 16px; margin-top: 5px; }
        .btn-add-ex { background: #34c759; color: white; border: none; padding: 10px; border-radius: 10px; width: 100%; font-weight: bold; cursor: pointer; font-size: 14px; margin-bottom: 10px; }
        .btn-delete { background: none; border: none; color: #ff3b30; cursor: pointer; font-size: 18px; padding: 5px; }
        .remove-ex { position: absolute; right: 0; top: 0; color: #ff3b30; font-weight: bold; cursor: pointer; padding: 5px; font-size: 20px; }

        .avg-week { padding: 10px; background: rgba(52, 199, 89, 0.15); border-radius: 10px; margin: 10px 0; font-weight: bold; color: #248a3d; font-size: 13px; text-align: center; border: 1px dashed #34c759; }
        .avg-month { padding: 12px; background: rgba(0, 122, 255, 0.15); border-radius: 10px; margin: 15px 0 5px 0; font-weight: bold; color: #007aff; font-size: 14px; text-align: center; border: 1px solid #007aff; }

        .weight-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .hidden { display: none; }
    </style>
</head>
<body>

<div id="app">
    <div class="tabs">
        <button id="btn-tab-workout" class="tab-btn active" onclick="showTab('workout')">üèãÔ∏è Edz√©s</button>
        <button id="btn-tab-weight" class="tab-btn" onclick="showTab('weight')">‚öñÔ∏è S√∫ly</button>
    </div>

    <div id="tab-workout">
        <div class="card">
            <h3>√öj Edz√©s</h3>
            <input type="date" id="workoutDate">
            <select id="workoutType" onchange="loadTemplate()">
                <option value="">-- Sablon --</option>
                <option value="felso">Fels≈ëtest</option>
                <option value="also">Als√≥test</option>
                <option value="egyedi">Egyedi (√úres)</option>
            </select>
            <div id="exercise-container"></div>
            <button id="add-custom-btn" class="btn-add-ex hidden" onclick="addCustomExercise()">+ Gyakorlat hozz√°ad√°sa</button>
            <button class="btn-primary" onclick="saveWorkout()">Ment√©s</button>
        </div>
        <div id="history-container"></div>
    </div>

    <div id="tab-weight" class="hidden">
        <div class="card">
            <h3>Tests√∫ly</h3>
            <div class="weight-input-group">
                <input type="date" id="weightDate">
                <input type="number" id="weightInput" step="0.1" placeholder="kg">
                <button class="btn-primary btn-ok" onclick="saveWeight()">OK</button>
            </div>
        </div>
        <div class="card">
            <div id="weightEntries"></div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, push, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCslE4Kc229j41Sm2l7ovpc_KEWhOb107k",
        authDomain: "bevasarlolista-dd660.firebaseapp.com",
        databaseURL: "https://bevasarlolista-dd660-default-rtdb.firebaseio.com",
        projectId: "bevasarlolista-dd660",
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const templates = {
        felso: ["Mellt√°maszos evez√©s", "Mellhez h√∫z√°s", "Fekvenyom√≥ g√©p", "V√°llb√≥l nyom√≥ g√©p", "Oldalemel√©s", "Bicepsz", "Tricepsz"],
        also: ["L√°btol√≥", "Combfesz√≠t≈ë", "Combhajl√≠t√≥", "Combk√∂zel√≠t≈ë", "Hip Thrust", "V√°dli"],
        egyedi: []
    };

    const napok = ["Vas√°rnap", "H√©tf≈ë", "Kedd", "Szerda", "Cs√ºt√∂rt√∂k", "P√©ntek", "Szombat"];

    window.loadTemplate = () => {
        const type = document.getElementById('workoutType').value;
        const container = document.getElementById('exercise-container');
        const addBtn = document.getElementById('add-custom-btn');
        container.innerHTML = "";
        if (!type) { addBtn.classList.add('hidden'); return; }
        addBtn.classList.remove('hidden');
        templates[type].forEach(ex => createExerciseBlock(ex));
    };

    window.addCustomExercise = () => {
        const name = prompt("Gyakorlat neve:");
        if (name) createExerciseBlock(name);
    };

    function createExerciseBlock(name) {
        const container = document.getElementById('exercise-container');
        const div = document.createElement('div');
        div.className = "exercise-block";
        div.innerHTML = `
            <span class="remove-ex" onclick="this.parentElement.remove()">‚úï</span>
            <span class="exercise-name" contenteditable="true">${name}</span>
            <div class="exercise-row">
                <input type="text" class="set-input" placeholder="1.">
                <input type="text" class="set-input" placeholder="2.">
                <input type="text" class="set-input" placeholder="3.">
                <input type="text" class="set-input" placeholder="4.">
            </div>
        `;
        container.appendChild(div);
    }

    window.saveWorkout = () => {
        const date = document.getElementById('workoutDate').value;
        if (!date) return alert("D√°tum k√∂telez≈ë!");
        const workoutData = { date, type: document.getElementById('workoutType').value, exercises: [] };
        document.querySelectorAll('.exercise-block').forEach(block => {
            const name = block.querySelector('.exercise-name').innerText;
            const sets = Array.from(block.querySelectorAll('.set-input')).map(i => {
                let s = i.value;
                if(s.includes('x') && !s.toLowerCase().includes('kg')) {
                    let parts = s.split('x');
                    return `${parts[0].trim()} kg x ${parts[1].trim()}`;
                }
                return s;
            });
            workoutData.exercises.push({ name, sets });
        });
        push(ref(db, 'workouts'), workoutData).then(() => {
            alert("Mentve!");
            document.getElementById('exercise-container').innerHTML = "";
            document.getElementById('workoutType').value = "";
            document.getElementById('add-custom-btn').classList.add('hidden');
        });
    };

    onValue(ref(db, 'weight_logs'), (snapshot) => {
        const data = snapshot.val();
        const container = document.getElementById('weightEntries');
        container.innerHTML = "";
        if (!data) return;
        const sortedDates = Object.keys(data).sort().reverse();
        let lastWeekId = null, lastMonthId = null;
        let weekBuffer = [], monthValues = [];

        sortedDates.forEach((date, index) => {
            const val = data[date].weight;
            const weekId = getWeekId(date);
            const monthId = date.substring(0, 7);
            if (lastMonthId && lastMonthId !== monthId) { renderAvgMonth(container, monthValues, lastMonthId); monthValues = []; }
            if (lastWeekId && lastWeekId !== weekId) { renderAvgWeek(container, weekBuffer); weekBuffer = []; }

            const dayName = napok[new Date(date).getDay()];
            container.innerHTML += `<div class="weight-row"><span>${date} <small>(${dayName})</small>: <strong>${val} kg</strong></span><button class="btn-delete" onclick="deleteWeight('${date}')">üóëÔ∏è</button></div>`;
            
            weekBuffer.push(val);
            monthValues.push(val);
            lastWeekId = weekId;
            lastMonthId = monthId;

            if (index === sortedDates.length - 1) { renderAvgWeek(container, weekBuffer); renderAvgMonth(container, monthValues, monthId); }
        });
    });

    function renderAvgWeek(container, buffer) {
        if (buffer.length === 0) return;
        const avg = buffer.reduce((a, b) => a + b, 0) / buffer.length;
        container.innerHTML += `<div class="avg-week">‚öñÔ∏è Heti √°tlag: ${avg.toFixed(2)} kg</div>`;
    }

    function renderAvgMonth(container, buffer, id) {
        if (buffer.length === 0) return;
        const avg = buffer.reduce((a, b) => a + b, 0) / buffer.length;
        container.innerHTML += `<div class="avg-month">üìÖ Havi √°tlag (${id}): ${avg.toFixed(2)} kg</div>`;
    }

    function getWeekId(dateStr) {
        const d = new Date(dateStr); d.setHours(0, 0, 0, 0);
        d.setDate(d.getDate() + 4 - (d.getDay() || 7));
        return d.getFullYear() + "-W" + Math.ceil((((d - new Date(d.getFullYear(), 0, 1)) / 86400000) + 1) / 7);
    }

    window.saveWeight = () => {
        const d = document.getElementById('weightDate').value;
        const w = document.getElementById('weightInput').value;
        if (d && w) set(ref(db, 'weight_logs/' + d), { weight: parseFloat(w) }).then(() => document.getElementById('weightInput').value = "");
    };

    window.deleteWorkout = (id) => { if(confirm("T√∂rl√∂d?")) remove(ref(db, `workouts/${id}`)); };
    window.deleteWeight = (date) => { if(confirm("T√∂rl√∂d?")) remove(ref(db, `weight_logs/${date}`)); };
    window.showTab = (t) => {
        document.getElementById('tab-workout').classList.toggle('hidden', t !== 'workout');
        document.getElementById('tab-weight').classList.toggle('hidden', t !== 'weight');
        document.getElementById('btn-tab-workout').classList.toggle('active', t === 'workout');
        document.getElementById('btn-tab-weight').classList.toggle('active', t === 'weight');
    };

    onValue(ref(db, 'workouts'), (snapshot) => {
        const data = snapshot.val();
        const container = document.getElementById('history-container');
        container.innerHTML = "<h3>El≈ëzm√©nyek</h3>";
        if (!data) return;
        const list = Object.keys(data).map(key => ({ id: key, ...data[key] })).sort((a,b) => new Date(b.date) - new Date(a.date));
        list.forEach(w => {
            const card = document.createElement('div');
            card.className = "card";
            let exHtml = w.exercises.map(ex => {
                const f = ex.sets.filter(s => s.trim() !== "");
                return f.length ? `<div style="font-size:13px;margin-top:4px;"><strong>${ex.name}:</strong> ${f.join(' | ')}</div>` : '';
            }).join('');
            card.innerHTML = `<div style="display:flex;justify-content:space-between;"><strong>${w.date} <small>(${napok[new Date(w.date).getDay()]})</small></strong><button class="btn-delete" onclick="deleteWorkout('${w.id}')">üóëÔ∏è</button></div>${exHtml}`;
            container.appendChild(card);
        });
    });

    document.getElementById('workoutDate').valueAsDate = new Date();
    document.getElementById('weightDate').valueAsDate = new Date();
</script>
</body>
</html>
